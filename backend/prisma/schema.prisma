// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  OWNER
  ADMIN
  USER
  GUEST
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  UNQUALIFIED
  CONVERTED
}

enum OpportunityStage {
  PROSPECTING
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

model User {
  id             Int           @id @default(autoincrement())
  clerkUserId    String        @unique // Clerk user id, canonical auth id
  email          String?       @unique
  firstName      String?
  lastName       String?
  phone          String?
  avatarUrl      String?
  role           Role          @default(USER)
  timezone       String? // e.g. "Africa/Nairobi"
  locale         String? // e.g. "en-US"
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId Int? // optional default org
  organization   Organization? @relation(fields: [organizationId], references: [id])

  teams         UserTeam[]
  activities    Activity[] // tasks/notes/calls created by user
  assignedTasks Task[]        @relation("taskAssignee")
  auditLogs     AuditLog[]
  contacts      Contact[] // contacts owned by user
  leads         Lead[] // leads owned by user
  notes         Note[]        @relation("NoteAuthor")
  opportunities Opportunity[] // Add opposite relation field
  quotes        Quote[] // Add opposite relation field
}

model Organization {
  id        Int      @id @default(autoincrement())
  name      String
  slug      String   @unique
  website   String?
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[] // users who belong to organization (via organizationId)
  teams         Team[]
  contacts      Contact[]
  leads         Lead[]
  opportunities Opportunity[]
  products      Product[]
  invoices      Invoice[]
  pipelines     Pipeline[] // relation to Pipeline
}

model Team {
  id             Int          @id @default(autoincrement())
  name           String
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  members        UserTeam[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model UserTeam {
  id     Int  @id @default(autoincrement())
  userId Int
  teamId Int
  role   Role @default(USER)
  user   User @relation(fields: [userId], references: [id])
  team   Team @relation(fields: [teamId], references: [id])

  @@unique([userId, teamId])
}

model Contact {
  id             Int           @id @default(autoincrement())
  firstName      String
  lastName       String
  email          String?       @unique
  phone          String?
  jobTitle       String?
  organizationId Int? // employer company
  organization   Organization? @relation(fields: [organizationId], references: [id])
  ownerId        Int? // user responsible
  owner          User?         @relation(fields: [ownerId], references: [id])
  tags           ContactTag[]
  customFields   Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  notes          Note[]
  activities     Activity[] // activities linked to contact
  leads          Lead[] // leads associated with contact
  opportunities  Opportunity[] // Add opposite relation field
}

model ContactTag {
  id        Int     @id @default(autoincrement())
  contactId Int
  tag       String
  contact   Contact @relation(fields: [contactId], references: [id])

  @@index([tag])
}

model Lead {
  id             Int           @id @default(autoincrement())
  source         String? // e.g., "web", "import", "campaign"
  status         LeadStatus    @default(NEW)
  contactId      Int? // who is the lead (nullable)
  contact        Contact?      @relation(fields: [contactId], references: [id])
  organizationId Int? // company lead pertains to
  organization   Organization? @relation(fields: [organizationId], references: [id])
  ownerId        Int? // assigned user
  owner          User?         @relation(fields: [ownerId], references: [id])
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  notes          Note[]
  activities     Activity[]
  opportunity    Opportunity?  @relation // Define relation without `fields` and `references`
}

model Opportunity {
  id             Int              @id @default(autoincrement())
  title          String
  value          Float?
  currency       String? // e.g., "USD"
  stage          OpportunityStage @default(PROSPECTING)
  probability    Int? // 0-100
  closeDate      DateTime?
  leadId         Int?             @unique // Add `@unique` for one-to-one relationship
  lead           Lead?            @relation(fields: [leadId], references: [id])
  contactId      Int? // primary contact
  contact        Contact?         @relation(fields: [contactId], references: [id])
  organizationId Int?
  organization   Organization?    @relation(fields: [organizationId], references: [id])
  ownerId        Int?
  owner          User?            @relation(fields: [ownerId], references: [id])
  pipelineId     Int? // optional pipeline reference
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  activities     Activity[]
  notes          Note[]
  quotes         Quote[]
}

model Pipeline {
  id     Int          @id @default(autoincrement())
  name   String
  stages String[] // e.g., ["Prospecting","Qualified","Proposal","Closed Won"]
  orgId  Int
  org    Organization @relation(fields: [orgId], references: [id])
}

model Activity {
  id            Int          @id @default(autoincrement())
  type          String // e.g., "call", "email", "task", "meeting"
  title         String?
  description   String?
  dueDate       DateTime?
  completed     Boolean      @default(false)
  userId        Int? // creator
  user          User?        @relation(fields: [userId], references: [id])
  contactId     Int?
  contact       Contact?     @relation(fields: [contactId], references: [id])
  opportunityId Int?
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id])
  leadId        Int?
  lead          Lead?        @relation(fields: [leadId], references: [id])
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  attachments   Attachment[]
}

model Task {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  dueDate     DateTime?
  completed   Boolean   @default(false)
  assigneeId  Int? // assigned to user
  assignee    User?     @relation("taskAssignee", fields: [assigneeId], references: [id])
  relatedType String? // e.g., "contact","opportunity" to simplify polymorphic links
  relatedId   Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Note {
  id            Int          @id @default(autoincrement())
  content       String
  authorId      Int?
  author        User?        @relation("NoteAuthor", fields: [authorId], references: [id])
  contactId     Int?
  contact       Contact?     @relation(fields: [contactId], references: [id])
  opportunityId Int?
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id])
  leadId        Int?
  lead          Lead?        @relation(fields: [leadId], references: [id])
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model Product {
  id             Int           @id @default(autoincrement())
  sku            String?       @unique
  name           String
  description    String?
  price          Float
  currency       String?
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  quotes         QuoteItem[]
}

model Quote {
  id            Int          @id @default(autoincrement())
  opportunityId Int?
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id])
  issuerId      Int? // user who created quote
  issuer        User?        @relation(fields: [issuerId], references: [id])
  total         Float?
  currency      String?
  status        String? // draft, sent, accepted, declined
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  items         QuoteItem[]
}

model QuoteItem {
  id        Int      @id @default(autoincrement())
  quoteId   Int
  productId Int?
  quantity  Int      @default(1)
  unitPrice Float
  quote     Quote    @relation(fields: [quoteId], references: [id])
  product   Product? @relation(fields: [productId], references: [id])
}

model Invoice {
  id             Int           @id @default(autoincrement())
  invoiceNumber  String        @unique
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  amount         Float
  currency       String?
  dueDate        DateTime?
  status         String? // draft, sent, paid, overdue
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Attachment {
  id         Int       @id @default(autoincrement())
  url        String
  filename   String
  size       Int?
  mimeType   String?
  activityId Int?
  activity   Activity? @relation(fields: [activityId], references: [id])
  createdAt  DateTime  @default(now())
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  entity    String // e.g., "Contact"
  entityId  Int
  action    String // create, update, delete
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
  changes   Json?
  createdAt DateTime @default(now())
}
