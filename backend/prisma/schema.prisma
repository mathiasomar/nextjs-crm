// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  MANAGER
  AGENT
  SUPPORT
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  UNQUALIFIED
  CONVERTED
}

enum OpportunityStage {
  PROSPECTING
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

model User {
  id          String   @id @default(uuid())
  clerkUserId String   @unique // Clerk user id, canonical auth id
  email       String?  @unique
  firstName   String?
  lastName    String?
  phone       String?
  avatarUrl   String?
  role        Role     @default(AGENT)
  department  String? // 'Sales', 'Support', 'Marketing'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Reverse relations
  assignedLeads         Lead[]
  assignedOpportunities Opportunity[]
  assignedCases         Case[]
  assignedActivities    Activity[]
  createdNotes          Note[]
  uploadedDocuments     Document[]

  @@map("users")
}

model Contact {
  id              String    @id @default(uuid())
  salutation      String?
  firstName       String    @map("first_name")
  lastName        String    @map("last_name")
  email           String    @unique
  phone           String?
  mobilePhone     String?   @map("mobile_phone")
  jobTitle        String?   @map("job_title")
  dateOfBirth     DateTime? @map("date_of_birth")
  mailingAddress  String?   @map("mailing_address")
  shippingAddress String?   @map("shipping_address")
  leadSource      String?   @map("lead_source")
  customerType    String?   @default("Prospect") @map("customer_type") // 'Prospect', 'Customer', 'VIP', 'Inactive'
  loyaltyTier     String?   @default("Bronze") @map("loyalty_tier")
  status          String?   @default("Active")
  createdAt       DateTime  @default(now()) @map("created_date")
  lastActivityAt  DateTime? @map("last_activity_at")
  customFields    Json?

  // Relations
  householdId     String?
  household       Household?       @relation(fields: [householdId], references: [id])
  transactions    Transaction[]
  opportunities   Opportunity[]
  cases           Case[]
  campaignMembers CampaignMember[]
  activities      Activity[]
  notes           Note[]
  documents       Document[]
  leads           Lead[]
  emailMessages   EmailMessage[]

  @@map("contacts")
}

model Household {
  id               String   @id @default(uuid())
  name             String
  primaryContactId String?  @map("primary_contact_id")
  sharedAddress    String?  @map("shared_address")
  createdAt        DateTime @default(now()) @map("created_date")

  // Relations
  members      Contact[]
  transactions Transaction[]

  @@map("households")
}

// Sales Pipeline Entities
model Lead {
  id            String    @id @default(uuid())
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  email         String
  phone         String?
  leadSource    String?   @map("lead_source") // 'Website', 'Social Media', 'Referral'
  status        String?   @default("New") // 'New', 'Contacted', 'Qualified', 'Converted', 'Unqualified'
  rating        String? // 'Hot', 'Warm', 'Cold'
  interests     String? // JSON string of product interests
  createdAt     DateTime  @default(now()) @map("created_date")
  convertedDate DateTime? @map("converted_date")

  // Relations
  assignedToId       String?
  assignedTo         User?            @relation(fields: [assignedToId], references: [id])
  convertedContactId String?
  convertedContact   Contact?         @relation(fields: [convertedContactId], references: [id])
  campaignMembers    CampaignMember[]
  activities         Activity[]
  emailMessages      EmailMessage[]

  @@map("leads")
}

model Opportunity {
  id          String    @id @default(uuid())
  name        String
  description String?
  amount      Float?
  stage       String?   @default("Prospecting") // 'Prospecting', 'Qualification', 'Proposal', 'Closed Won', 'Closed Lost'
  probability Float?    @default(0.1) // 0.00 to 1.00
  closeDate   DateTime? @map("close_date")
  type        String?   @default("New Business") // 'New Business', 'Upsell', 'Renewal'
  leadSource  String?   @map("lead_source")
  createdAt   DateTime  @default(now()) @map("created_date")
  wonDate     DateTime? @map("won_date")

  // Relations
  contactId    String
  contact      Contact              @relation(fields: [contactId], references: [id])
  assignedToId String?
  assignedTo   User?                @relation(fields: [assignedToId], references: [id])
  products     OpportunityProduct[]
  activities   Activity[]

  @@map("opportunities")
}

// Product and Order Management
model Product {
  id          String   @id @default(uuid())
  name        String
  sku         String?  @unique
  description String?
  category    String?
  price       Float?
  cost        Float?
  isActive    Boolean? @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_date")

  // Relations
  opportunityProducts OpportunityProduct[]
  transactions        Transaction[]
  transactionProducts TransactionProduct[]

  @@map("products")
}

model OpportunityProduct {
  id         String @id @default(uuid())
  quantity   Int?   @default(1)
  unitPrice  Float? @map("unit_price")
  discount   Float? @default(0)
  totalPrice Float? @map("total_price")

  // Relations
  opportunityId String
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id])
  productId     String
  product       Product     @relation(fields: [productId], references: [id])

  @@map("opportunity_products")
}

model Transaction {
  id              String   @id @default(uuid())
  orderId         String   @unique @map("order_id")
  totalAmount     Float    @map("total_amount")
  status          String?  @default("Completed") // 'Pending', 'Completed', 'Cancelled', 'Refunded'
  paymentMethod   String?  @map("payment_method")
  transactionDate DateTime @default(now()) @map("transaction_date")

  // Relations
  contactId   String
  contact     Contact              @relation(fields: [contactId], references: [id])
  householdId String?
  household   Household?           @relation(fields: [householdId], references: [id])
  products    TransactionProduct[]
  product     Product?             @relation(fields: [productId], references: [id])
  productId   String?

  @@map("transactions")
}

model TransactionProduct {
  id         String @id @default(uuid())
  quantity   Int    @default(1)
  unitPrice  Float  @map("unit_price")
  discount   Float? @default(0)
  totalPrice Float  @map("total_price")

  // Relations
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  productId     String
  product       Product     @relation(fields: [productId], references: [id])

  @@map("transaction_products")
}

// Customer Service Entities
model Case {
  id           String    @id @default(uuid())
  subject      String
  description  String?
  type         String?   @default("Question") // 'Question', 'Problem', 'Compliment', 'Suggestion'
  priority     String?   @default("Medium") // 'Low', 'Medium', 'High', 'Critical'
  status       String?   @default("New") // 'New', 'In Progress', 'Resolved', 'Closed'
  createdAt    DateTime  @default(now()) @map("created_date")
  resolvedDate DateTime? @map("resolved_date")

  // Relations
  contactId    String
  contact      Contact    @relation(fields: [contactId], references: [id])
  assignedToId String?
  assignedTo   User?      @relation(fields: [assignedToId], references: [id])
  activities   Activity[]

  @@map("cases")
}

// Marketing Entities
model Campaign {
  id              String    @id @default(uuid())
  name            String
  type            String? // 'Email', 'SMS', 'Social Media', 'Direct Mail'
  status          String?   @default("Planning") // 'Planning', 'Active', 'Completed', 'Cancelled'
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  budget          Float?
  expectedRevenue Float?    @map("expected_revenue")
  createdAt       DateTime  @default(now()) @map("created_date")

  // Relations
  campaignMembers CampaignMember[]

  @@map("campaigns")
}

model CampaignMember {
  id            String    @id @default(uuid())
  status        String?   @default("Sent") // 'Sent', 'Opened', 'Clicked', 'Responded', 'Converted'
  respondedDate DateTime? @map("responded_date")

  // Relations
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])
  leadId     String?
  lead       Lead?    @relation(fields: [leadId], references: [id])
  contactId  String?
  contact    Contact? @relation(fields: [contactId], references: [id])

  @@unique([campaignId, leadId])
  @@unique([campaignId, contactId])
  @@map("campaign_members")
}

// Activity Tracking Entities
model Activity {
  id            String    @id @default(uuid())
  type          String // 'Call', 'Email', 'Meeting', 'Task', 'Note'
  subject       String?
  description   String?
  dueDate       DateTime? @map("due_date")
  completedDate DateTime? @map("completed_date")
  status        String?   @default("Not Started") // 'Not Started', 'In Progress', 'Completed', 'Cancelled'
  priority      String?   @default("Normal") // 'Low', 'Normal', 'High'
  createdAt     DateTime  @default(now()) @map("created_date")

  // Relations
  contactId     String?
  contact       Contact?     @relation(fields: [contactId], references: [id])
  leadId        String?
  lead          Lead?        @relation(fields: [leadId], references: [id])
  assignedToId  String?
  assignedTo    User?        @relation(fields: [assignedToId], references: [id])
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id])
  opportunityId String?
  case          Case?        @relation(fields: [caseId], references: [id])
  caseId        String?

  @@map("activities")
}

model EmailMessage {
  id          String    @id @default(uuid())
  fromAddress String?   @map("from_address")
  toAddress   String?   @map("to_address")
  subject     String?
  body        String?
  direction   String? // 'Inbound', 'Outbound'
  sentDate    DateTime? @map("sent_date")
  status      String? // 'Sent', 'Delivered', 'Opened', 'Clicked'

  // Relations
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])
  leadId    String?
  lead      Lead?    @relation(fields: [leadId], references: [id])

  @@map("email_messages")
}

// Supporting Tables
model Note {
  id        String   @id @default(uuid())
  title     String?
  content   String?
  createdAt DateTime @default(now()) @map("created_date")

  // Relations
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id])

  @@map("notes")
}

model Document {
  id           String   @id @default(uuid())
  fileName     String?  @map("file_name")
  fileType     String?  @map("file_type")
  fileSize     Int?     @map("file_size")
  uploadedDate DateTime @default(now()) @map("uploaded_date")

  // Relations
  contactId    String?
  contact      Contact? @relation(fields: [contactId], references: [id])
  uploadedById String?
  uploadedBy   User?    @relation(fields: [uploadedById], references: [id])

  @@map("documents")
}
